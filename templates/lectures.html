{% extends "base.html" %}
{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/sorting-visualization.css') }}">
<style>
  #bg-grid {
    position: fixed;
    top: 50%;
    left: 50%;
    display: grid;
    transform: translate(-50%, -50%);
    z-index: -10;
    pointer-events: none;
  }

  .grid-cell {
    width: 60px;
    height: 60px;
    background: #0a1a3a;
    transition: background 0.12s linear, box-shadow 0.12s ease, border-color 0.12s ease, transform 0.12s ease;
    box-sizing: border-box;
    border: 2px solid rgba(255,255,255,0.06);
    opacity: 1;
  }

  .grid-cell:hover {
    border-color: rgba(255,255,255,0.12);
    box-shadow: 0 2px 8px rgba(0,0,0,0.35);
    transform: translateY(-2px);
  }

  .grid-cell.active {
    background: #1e90ff;
    border-color: rgba(30,144,255,0.9);
    box-shadow: 0 0 14px rgba(30,144,255,0.35), inset 0 0 6px rgba(255,255,255,0.04);
  }

  @keyframes cellPulse {
    0% { background: #1e90ff; }
    100% { background: #0a1a3a; }
  }

  .grid-cell.pulse {
    animation: cellPulse 0.4s forwards;
  }
</style>
{% endblock styles %}

{% block content %}
<div id="bg-grid"></div>

<main class="lectures-page">
  <section class="lectures-header">
    <button id="btn-create-post" class="btn btn-primary" aria-haspopup="dialog">Create a Post</button>
  </section>
<section id="posts-list">
  <!-- ========================= -->
  <!-- REGULAR POSTS             -->
  <!-- ========================= -->
  {% for post in posts %}
    {% if post.id > 0 %}
      <article class="post-card" data-id="{{ post.id }}">
        {% if current_user and post.user_id == current_user.id %}
        <div class="three-dots" data-id="{{ post.id }}">‚ãØ</div>
        <div class="dropdown-menu" id="menu-{{ post.id }}">
          <button class="edit-post" data-id="{{ post.id }}" data-title="{{ post.title }}" data-caption="{{ post.caption }}">‚úèÔ∏è Edit</button>
          <button class="delete-post" onclick="deletePost({{ post.id }})">üóëÔ∏è Delete</button>
        </div>
        {% endif %}

        <header>
          <h3 class="post-title">{{ post.title }}</h3>
          <p class="post-caption preserve">{{ post.caption_html | safe}}</p>
          <p style="font-size:0.85rem;color:var(--muted);margin:4px 0;">By {{ post.author }}</p>
        </header>
        <div class="post-meta" style="margin-top:8px;color:var(--muted);font-size:0.9rem;">
          <strong>Related Topics:</strong> {{ post.related_count }}
        </div>
            {% if post.latest_comment %}
            <div class="post-meta" style="margin-top:6px;color:var(--muted);font-size:0.9rem;">
              <strong>Latest Comment:</strong> <span class="preserve">{{ post.latest_comment }}</span>
            </div>
            {% endif %}
            <div class="comments">
              <div class="comments-list" id="comments-{{ post.id }}"></div>
              <textarea id="comment-input-{{ post.id }}" placeholder="Add a comment‚Ä¶" rows="2"></textarea>
              <div style="margin-top:6px;display:flex;gap:.5rem;">
                <button class="btn btn-primary" onclick="submitComment({{ post.id }})">Comment</button>
                <button class="btn" onclick="loadComments({{ post.id }})">Load All</button>
              </div>
            </div>
        <footer>
          <button class="vote-up" data-id="{{ post.id }}">‚ñ≤ <span class="count">{{ post.up }}</span></button>
          <button class="vote-down" data-id="{{ post.id }}">‚ñº <span class="count">{{ post.down }}</span></button>
          {% if post.attachments and post.attachments|length > 0 %}
            <div class="attachments" style="margin-top:6px;">
              <strong>Attachments:</strong>
              <ul>
                {% for a in post.attachments %}
                  <li><a href="/{{ a.url }}" target="_blank">{{ a.filename }}</a></li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}
        </footer>
      </article>
    {% endif %}
  {% endfor %}

</section>

  <!-- ========================= -->
  <!-- SORTING ALGORITHMS -->
  <!-- ========================= -->
  <!-- BUBBLE SORT -->
  <article class="post-card">
    <header>
      <h3 class="post-title">Bubble Sort</h3>
      <p class="post-caption">A simple comparison-based sorting algorithm that repeatedly steps through the list, compares adjacent elements and swaps them if they are in the wrong order.</p>
    </header>

    <div class="complexity">
      <strong>Time Complexity:</strong> O(n¬≤) in worst and average cases, O(n) in best case (already sorted)<br>
      <strong>Space Complexity:</strong> O(1)
    </div>

    <div style="margin:10px 0;">
      <button id="bubble-sort-start">Start Bubble Sort</button>
      <button id="bubble-sort-reset">Reset</button>
      <button id="bubble-sort-step">Step</button>
    </div>

    <div id="bubble-sort-display" style="padding:10px;border:1px solid #ccc;height:200px;position:relative;overflow:hidden;">
      <div id="bubble-sort-bars" style="display:flex;height:100%;align-items:flex-end;gap:2px;"></div>
    </div>

    <div class="explanation" style="margin-top:15px;">
      <h4>How it works:</h4>
      <ol>
        <li>Start from the first element, compare it with the next element.</li>
        <li>If the first element is greater than the second, swap them.</li>
        <li>Move to the next pair of elements and repeat step 2.</li>
        <li>After each pass, the largest element will 'bubble up' to its correct position.</li>
        <li>Repeat the process for the remaining elements.</li>
      </ol>
    </div>
  </article>

  <!-- MERGE SORT -->
  <article class="post-card">
    <header>
      <h3 class="post-title">Merge Sort</h3>
      <p class="post-caption">A stable, comparison-based, divide and conquer sorting algorithm that works by dividing the array into two halves, sorting them, and then merging them back together.</p>
    </header>

    <div class="complexity">
      <strong>Time Complexity:</strong> O(n log n) in all cases<br>
      <strong>Space Complexity:</strong> O(n) for the temporary array
    </div>

    <div style="margin:10px 0;">
      <button id="merge-sort-start">Start Merge Sort</button>
      <button id="merge-sort-reset">Reset</button>
      <button id="merge-sort-step">Step</button>
    </div>

    <div id="merge-sort-display" style="padding:10px;border:1px solid #ccc;height:200px;position:relative;overflow:hidden;">
      <div id="merge-sort-bars" style="display:flex;height:100%;align-items:flex-end;gap:2px;"></div>
    </div>

    <div class="explanation" style="margin-top:15px;">
      <h4>How it works:</h4>
      <ol>
        <li>Divide the unsorted list into n sublists, each containing one element.</li>
        <li>Repeatedly merge sublists to produce new sorted sublists until there is only one sublist remaining.</li>
        <li>This final sublist is the sorted list.</li>
      </ol>
    </div>
  </article>

  <!-- SELECTION SORT -->
  <article class="post-card">
    <header>
      <h3 class="post-title">Selection Sort</h3>
      <p class="post-caption">A simple sorting algorithm that works by repeatedly finding the minimum element from the unsorted part and putting it at the beginning.</p>
    </header>

    <div class="complexity">
      <strong>Time Complexity:</strong> O(n¬≤) in all cases<br>
      <strong>Space Complexity:</strong> O(1)
    </div>

    <div style="margin:10px 0;">
      <button id="selection-sort-start">Start Selection Sort</button>
      <button id="selection-sort-reset">Reset</button>
      <button id="selection-sort-step">Step</button>
    </div>

    <div id="selection-sort-display" style="padding:10px;border:1px solid #ccc;height:200px;position:relative;overflow:hidden;">
      <div id="selection-sort-bars" style="display:flex;height:100%;align-items:flex-end;gap:2px;"></div>
    </div>

    <div class="explanation" style="margin-top:15px;">
      <h4>How it works:</h4>
      <ol>
        <li>Find the minimum element in the unsorted part of the array.</li>
        <li>Swap it with the first element of the unsorted part.</li>
        <li>Move the boundary of the unsorted part one element to the right.</li>
        <li>Repeat until the entire array is sorted.</li>
      </ol>
    </div>
  </article>

  <!-- INSERTION SORT -->
  <article class="post-card">
    <header>
      <h3 class="post-title">Insertion Sort</h3>
      <p class="post-caption">A simple sorting algorithm that builds the final sorted array one item at a time by comparisons.</p>
    </header>

    <div class="complexity">
      <strong>Time Complexity:</strong> O(n¬≤) in worst and average cases, O(n) in best case (already sorted)<br>
      <strong>Space Complexity:</strong> O(1)
    </div>

    <div style="margin:10px 0;">
      <button id="insertion-sort-start">Start Insertion Sort</button>
      <button id="insertion-sort-reset">Reset</button>
      <button id="insertion-sort-step">Step</button>
    </div>

    <div id="insertion-sort-display" style="padding:10px;border:1px solid #ccc;height:200px;position:relative;overflow:hidden;">
      <div id="insertion-sort-bars" style="display:flex;height:100%;align-items:flex-end;gap:2px;"></div>
    </div>

    <div class="explanation" style="margin-top:15px;">
      <h4>How it works:</h4>
      <ol>
        <li>Start from the second element (consider the first element as sorted).</li>
        <li>Compare the current element with the previous elements.</li>
        <li>If the current element is smaller, move the larger elements one position up.</li>
        <li>Insert the current element in its correct position.</li>
        <li>Repeat for all elements in the array.</li>
      </ol>
    </div>
  </article>

  <!-- QUEUE DEMO -->
  <article class="post-card">
    <header>
      <h3 class="post-title">Queue Interactive Demo</h3>
      <p class="post-caption">Visualize enqueue and dequeue operations in real time.</p>
    </header>

    <div style="margin:10px 0;">
      <input id="queue-input" type="text" placeholder="Value‚Ä¶" />
      <button id="queue-enqueue">Enqueue</button>
      <button id="queue-dequeue">Dequeue</button>
    </div>

    <div id="queue-display" style="padding:10px;border:1px solid #ccc;">
      <svg id="queue-svg" width="1000" height="400"></svg>
    </div>
  </article>

  <!-- STACK DEMO -->
  <article class="post-card">
    <header>
      <h3 class="post-title">Stack Interactive Demo</h3>
      <p class="post-caption">Push and pop to see how LIFO works.</p>
    </header>

    <div style="margin:10px 0;">
      <input id="stack-input" type="text" placeholder="Value‚Ä¶" />
      <button id="stack-push">Push</button>
      <button id="stack-pop">Pop</button>
    </div>

    <div id="stack-display" style="padding:10px;border:1px solid #ccc;">
      <svg id="stack-svg" width="200" height="400"></svg>
    </div>
  </article>

  <!-- TREE DEMO -->
  <article class="post-card">
    <header>
      <h3 class="post-title">Tree (General) Interactive Demo</h3>
      <p class="post-caption">Add children to selected nodes.</p>
    </header>

    <div style="margin:10px 0;">
      <input id="tree-input" type="text" placeholder="Node value‚Ä¶" />
      <button id="tree-add-root">Add Root</button>
      <button id="tree-add-child">Add Child</button>
      <button id="tree-reset">Reset</button>
      <button id="tree-delete-node">Delete Node</button>
    </div>

    <div id="tree-display" style="padding:10px;border:1px solid #ccc;">
      <svg id="tree-svg" width="1000" height="600"></svg>
    </div>
    <div id="tree-detached" style="margin-top:8px;"></div>
  </article>

  <!-- BINARY TREE DEMO -->
  <article class="post-card">
    <header>
      <h3 class="post-title">Binary Tree Demo</h3>
      <p class="post-caption">Insert nodes left or right.</p>
    </header>

    <div style="margin:10px 0;">
      <input id="bt-input" type="text" placeholder="Value‚Ä¶" />
      <button id="bt-add-left">Add Left</button>
      <button id="bt-add-root">Add Root</button>
      <button id="bt-add-right">Add Right</button>
      <button id="bt-reset">Reset</button>
      <button id="bt-delete-node">Delete Node</button>
    </div>

    <div id="bt-display" style="padding:10px;border:1px solid #ccc;">
      <svg id="bt-svg" width="1000" height="600"></svg>
    </div>
    <div id="bt-detached" style="margin-top:8px;"></div>
  </article>

  <!-- BST DEMO -->
  <article class="post-card">
    <header>
      <h3 class="post-title">BST Demo</h3>
      <p class="post-caption">Insert values into a Binary Search Tree.</p>
    </header>

<div style="margin:10px 0;">
  <input id="bst-input" type="text" placeholder="Insert / Search / Delete‚Ä¶" />
  <button id="bst-insert">Insert</button>
  <button id="bst-delete">Delete</button>
  <button id="bst-search">Search</button>
  <button id="bst-max">Max Value</button>
  <button id="bst-height">Height</button>
  <button id="bst-reset">Reset</button>
</div>

<div id="bst-info" style="margin-top:10px;font-weight:bold;"></div>


    <div id="bst-display" style="padding:10px;border:1px solid #ccc;">
      <svg id="bst-svg" width="1000" height="600"></svg>
    </div>
    <div id="bst-detached" style="margin-top:8px;"></div>
  </article>

  <!-- GRAPH DEMO -->
  <article class="post-card">
    <header>
      <h3 class="post-title">Graph Demo</h3>
      <p class="post-caption">Directed / Undirected graph with weighted edges (parallel edges collapse into weight).</p>
    </header>

    <div style="margin:10px 0;display:flex;gap:.5rem;flex-wrap:wrap;">
      <input id="graph-vertex-label" type="text" placeholder="Vertex label‚Ä¶" />
      <button id="graph-add-vertex">Add Vertex</button>
      <input id="graph-delete-vertex-id" type="text" placeholder="Vertex id to delete‚Ä¶" />
      <button id="graph-delete-vertex">Delete Vertex</button>
      <input id="graph-edge-u" type="text" placeholder="From id‚Ä¶" />
      <input id="graph-edge-v" type="text" placeholder="To id‚Ä¶" />
      <label><input type="checkbox" id="graph-directed" /> Directed</label>
      <button id="graph-add-edge">Add Edge (collapse -> weight)</button>
      <input id="graph-weight" type="number" placeholder="Weight‚Ä¶" style="width:80px;" />
      <button id="graph-set-weight">Set Weight</button>
      <button id="graph-reset">Reset</button>
    </div>

    <div id="graph-display" style="padding:10px;border:1px solid #ccc;margin-top:8px;">
      <svg id="graph-svg" width="800" height="400"></svg>
    </div>
  </article>


<!-- ===================================== -->
<!-- POST MODAL (CREATE + EDIT)            -->
<!-- ===================================== -->
<div id="create-post-modal" class="modal" role="dialog" aria-hidden="true">
  <div class="modal-content">
    <h2 id="modal-title">Create a Post</h2>

    <form id="post-form" method="POST" enctype="multipart/form-data" action="{{ url_for('create_post') }}">
      <input type="hidden" id="post-id" name="id" value="">
      <input type="hidden" id="post-author-input" name="author" value="">

      <label>Title:</label>
      <input type="text" id="post-title-input" name="title" required>

      <label>Caption:</label>
      <textarea id="post-caption-input" name="caption" required></textarea>

      <label>Post Type:</label>
      <select name="post_type">
        <option value="regular">Regular</option>
      </select>

      <label>Attachments:</label>
      <input type="file" id="post-attachments" name="attachments" multiple />

      <div style="margin-top:10px;">
        <button type="submit" class="btn btn-primary">Save</button>
        <button type="button" class="btn btn-ghost" id="post-cancel">Cancel</button>
      </div>
    </form>
  </div>
</div>
<div id="snackbar" class="snackbar" style="display:none;">
  Deleting in 5 seconds...
  <button onclick="cancelDelete()">Cancel</button>
</div>

<!-- ===================================== -->
<!-- Sorting Visualization JS             -->
<!-- ===================================== -->
<script src="{{ url_for('static', filename='js/sorting-visualization.js') }}"></script>

<!-- ===================================== -->
<!-- JAVASCRIPT FIXED                      -->
<!-- ===================================== -->
<script>
/* ----------------------------- */
/* Element refs                 */
/* ----------------------------- */
const createPostBtn = document.getElementById('btn-create-post');
const createPostModal = document.getElementById('create-post-modal');
const cancelPostBtn = document.getElementById('post-cancel');
const modalTitle = document.getElementById('modal-title');
const postForm = document.getElementById('post-form');
const postIdInput = document.getElementById('post-id');
const postTitleInput = document.getElementById('post-title-input');
const postCaptionInput = document.getElementById('post-caption-input');
const postAuthorInput = document.getElementById('post-author-input');

/* ----------------------------- */
/* Modal Actions                 */
/* ----------------------------- */
createPostBtn.addEventListener('click', () => {
  modalTitle.innerText = "Create a Post";
  postForm.action = "{{ url_for('create_post') }}";
  postIdInput.value = "";
  postTitleInput.value = "";
  postCaptionInput.value = "";
  postAuthorInput.value = "";
  createPostModal.style.display = "flex";
});

cancelPostBtn.addEventListener('click', () => {
  createPostModal.style.display = "none";
});

window.addEventListener('click', (e) => {
  if (e.target === createPostModal) createPostModal.style.display = "none";
});

/* ----------------------------- */
/* Dropdown menu                */
/* ----------------------------- */
document.addEventListener('click', (e) => {
  const dots = e.target.closest('.three-dots');
  const insideMenu = e.target.closest('.dropdown-menu');

  if (dots) {
    const id = dots.dataset.id;
    const menu = document.getElementById(`menu-${id}`);
    document.querySelectorAll('.dropdown-menu').forEach(m => {
      if (m !== menu) m.style.display = 'none';
    });
    menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    return;
  }

  if (!insideMenu) {
    document.querySelectorAll('.dropdown-menu').forEach(m => m.style.display = 'none');
  }
});

/* ----------------------------- */
/* Edit post                    */
/* ----------------------------- */
document.querySelectorAll('.edit-post').forEach(btn => {
  btn.addEventListener('click', () => {
    modalTitle.innerText = "Edit Post";
    postForm.action = `/edit/${btn.dataset.id}`;
    postIdInput.value = btn.dataset.id;
    postTitleInput.value = btn.dataset.title;
    postCaptionInput.value = btn.dataset.caption;
    postAuthorInput.value = btn.dataset.author;
    createPostModal.style.display = "flex";
  });
});

/* Helper: safely insert an SVG string into an HTML container preserving namespace
   Uses DOMParser to avoid HTML->SVG namespace issues that can prevent rendering */
function insertSVG(container, svgString) {
  if (!container) return;
  try {
    const parser = new DOMParser();
    const doc = parser.parseFromString(svgString, 'image/svg+xml');
    const svg = doc.querySelector('svg');
    container.innerHTML = '';
    if (svg) {
      svg.setAttribute('preserveAspectRatio', 'xMidYMid meet');
      svg.removeAttribute('width');
      svg.removeAttribute('height');
      container.appendChild(svg);
      // attach click handlers for nodes (if any)
      try { attachSVGNodeClicks(container); } catch(e) {}
    } else {
      // fallback to raw HTML insertion
      container.innerHTML = svgString;
    }
  } catch (e) {
    container.innerHTML = svgString;
  }
}

// selection state for demos
let selectedTree = null;
let selectedBT = null;
let selectedBST = null;

function clearHighlights(container) {
  const svgs = container.querySelectorAll('svg');
  svgs.forEach(svg => {
    svg.querySelectorAll('circle').forEach(c => c.style.stroke = '');
  });
}

function attachSVGNodeClicks(container) {
  if (!container) return;
  const svg = container.querySelector('svg');
  if (!svg) return;
  svg.querySelectorAll('circle[data-id]').forEach(circle => {
    circle.style.cursor = 'pointer';
    circle.addEventListener('click', (e) => {
      const id = circle.getAttribute('data-id');
      const val = circle.getAttribute('data-val');
      // determine which demo by container id
      const cid = container.id || '';
      // clear previous highlights in this container
      svg.querySelectorAll('circle').forEach(c => c.style.stroke = '');
      circle.style.stroke = '#ffd54f';
      circle.style.strokeWidth = '4px';

      if (cid.includes('tree')) {
        selectedTree = id;
        const inp = document.getElementById('tree-input'); if (inp) inp.value = val;
      }
      else if (cid.includes('bt')) {
        selectedBT = id;
        const inp = document.getElementById('bt-input'); if (inp) inp.value = val;
      }
      else if (cid.includes('bst')) {
        selectedBST = id;
        const inp = document.getElementById('bst-input'); if (inp) inp.value = val;
      }
    });
  });
}

    /* ============================= */
/* QUEUE DEMO                    */
/* ============================= */
document.getElementById("queue-enqueue").onclick = async () => {
  const val = document.getElementById("queue-input").value;

  const res = await fetch("/queue/enqueue", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ value: val })
  });

  const data = await res.json();
  if (data.svg) insertSVG(document.getElementById("queue-display"), data.svg);
};

document.getElementById("queue-dequeue").onclick = async () => {
  const res = await fetch("/queue/dequeue", { method: "POST" });
  const data = await res.json();
  if (data.svg) insertSVG(document.getElementById("queue-display"), data.svg);
};


/* ============================= */
/* STACK DEMO                    */
/* ============================= */
document.getElementById("stack-push").onclick = async () => {
  const val = document.getElementById("stack-input").value;

  const res = await fetch("/stack/push", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ value: val })
  });

  const data = await res.json();
  if (data.svg) insertSVG(document.getElementById("stack-display"), data.svg);
};

document.getElementById("stack-pop").onclick = async () => {
  const res = await fetch("/stack/pop", { method: "POST" });
  const data = await res.json();
  if (data.svg) insertSVG(document.getElementById("stack-display"), data.svg);
};


/* ============================= */
/* GENERIC TREE DEMO             */
/* ============================= */
document.getElementById("tree-add-root").onclick = async () => {
  const val = document.getElementById("tree-input").value;
  const res = await fetch("/tree/insert", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ value: val })
  });

  const data = await res.json();
  if (data.svg) insertSVG(document.getElementById("tree-display"), data.svg);
};

// Add child to selected node (requires clicking a node first)
document.getElementById("tree-add-child").onclick = async () => {
  const val = document.getElementById("tree-input").value;
  const parent = selectedTree;
  const res = await fetch("/tree/insert", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ value: val, parent: parent })
  });
  const data = await res.json();
  if (data.svg) insertSVG(document.getElementById("tree-display"), data.svg);
};

document.getElementById("tree-reset").onclick = async () => {
  const res = await fetch("/tree/reset", { method: "POST" });
  const data = await res.json();
  if (data.svg) insertSVG(document.getElementById("tree-display"), data.svg);
};


/* ============================= */
/* BINARY TREE DEMO              */
/* ============================= */
document.getElementById("bt-add-left").onclick = async () => {
  const val = document.getElementById("bt-input").value;
  const parent = selectedBT;
  const res = await fetch("/bt/add-left", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ value: val, parent: parent })
  });

  const data = await res.json();
  if (data.svg) insertSVG(document.getElementById("bt-display"), data.svg);
};

document.getElementById("bt-add-right").onclick = async () => {
  const val = document.getElementById("bt-input").value;
  const parent = selectedBT;
  const res = await fetch("/bt/add-right", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ value: val, parent: parent })
  });

  const data = await res.json();
  if (data.svg) insertSVG(document.getElementById("bt-display"), data.svg);
};

document.getElementById("bt-add-root").onclick = async () => {
  const val = document.getElementById("bt-input").value;
  const res = await fetch("/bt/add-root", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ value: val })
  });
  const data = await res.json();
  if (data.svg) insertSVG(document.getElementById("bt-display"), data.svg);
};

document.getElementById("bt-reset").onclick = async () => {
  const res = await fetch("/bt/reset", { method: "POST" });
  const data = await res.json();
  if (data.svg) insertSVG(document.getElementById("bt-display"), data.svg);
};


/* ============================= */
/* BST DEMO                      */
/* ============================= */
document.getElementById("bst-insert").onclick = async () => {
  const val = document.getElementById("bst-input").value;

  const res = await fetch("/bst/insert", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ value: val })
  });

  const data = await res.json();
  if (data.svg) insertSVG(document.getElementById("bst-display"), data.svg);
};

document.getElementById("bst-reset").onclick = () => {
  document.getElementById("bst-display").innerHTML = "";
};

    document.getElementById("bst-delete").onclick = async () => {
  const val = document.getElementById("bst-input").value;

  const res = await fetch("/bst/delete", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ value: val })
  });

  const data = await res.json();
  if (data.svg) insertSVG(document.getElementById("bst-display"), data.svg);
  const detachedContainer = document.getElementById('bst-detached');
  detachedContainer.innerHTML = '';
  if (data.detached_svg) {
    const header = document.createElement('div');
    header.style.marginBottom = '6px';
    header.innerHTML = `<strong>Detached subtree (root: ${data.detached_root})</strong> <button class="btn" id="reinsert-detached">Reinsert root</button>`;
    detachedContainer.appendChild(header);
    const svgWrap = document.createElement('div');
    svgWrap.style.border = '1px dashed rgba(255,255,255,0.06)';
    svgWrap.style.padding = '6px';
    svgWrap.innerHTML = data.detached_svg;
    detachedContainer.appendChild(svgWrap);
    // reattach using server-side stored subtree token
    document.getElementById('reinsert-detached').addEventListener('click', async () => {
      const token = data.token;
      if (!token) return;
      const res = await fetch(`/reattach/${token}`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({}) });
      const d = await res.json();
      if (d.svg) insertSVG(document.getElementById('bst-display'), d.svg);
      detachedContainer.innerHTML = '';
    });
    try { attachSVGNodeClicks(svgWrap); } catch(e) {}
  }
};

// Tree delete (delete selected node)
document.getElementById('tree-delete-node').onclick = async () => {
  if (!selectedTree) { alert('Select a node first'); return; }
  const res = await fetch('/tree/delete', {
    method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ id: selectedTree })
  });
  const data = await res.json();
  if (data.svg) insertSVG(document.getElementById('tree-display'), data.svg);
  const container = document.getElementById('tree-detached');
  container.innerHTML = '';
  if (data.detached_svg) {
    const header = document.createElement('div');
    header.style.marginBottom = '6px';
    header.innerHTML = `<strong>Detached subtree</strong> <button class="btn" id="tree-reinsert">Reinsert root</button>`;
    container.appendChild(header);
    const svgWrap = document.createElement('div');
    svgWrap.style.border = '1px dashed rgba(255,255,255,0.06)';
    svgWrap.style.padding = '6px';
    svgWrap.innerHTML = data.detached_svg;
    container.appendChild(svgWrap);
    document.getElementById('tree-reinsert').addEventListener('click', async () => {
      const token = data.token;
      if (!token) return;
      // attach under selectedTree if available
      const payload = {};
      if (selectedTree) payload.parent = selectedTree;
      const r = await fetch(`/reattach/${token}`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      const d = await r.json();
      if (d.svg) insertSVG(document.getElementById('tree-display'), d.svg);
    });
    try { attachSVGNodeClicks(svgWrap); } catch(e) {}
  }
};

// BT delete (delete selected node)
document.getElementById('bt-delete-node').onclick = async () => {
  if (!selectedBT) { alert('Select a node first'); return; }
  const res = await fetch('/bt/delete', {
    method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ id: selectedBT })
  });
  const data = await res.json();
  if (data.svg) insertSVG(document.getElementById('bt-display'), data.svg);
  const container = document.getElementById('bt-detached');
  container.innerHTML = '';
  if (data.detached_svg) {
    const header = document.createElement('div');
    header.style.marginBottom = '6px';
    header.innerHTML = `<strong>Detached subtree</strong> <button class="btn" id="bt-reinsert">Reinsert root</button>`;
    container.appendChild(header);
    const svgWrap = document.createElement('div');
    svgWrap.style.border = '1px dashed rgba(255,255,255,0.06)';
    svgWrap.style.padding = '6px';
    svgWrap.innerHTML = data.detached_svg;
    container.appendChild(svgWrap);
    document.getElementById('bt-reinsert').addEventListener('click', async () => {
      const token = data.token;
      if (!token) return;
      const payload = {};
      if (selectedBT) payload.parent = selectedBT;
      const r = await fetch(`/reattach/${token}`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      const d = await r.json();
      if (d.svg) insertSVG(document.getElementById('bt-display'), d.svg);
    });
    try { attachSVGNodeClicks(svgWrap); } catch(e) {}
  }
};


document.getElementById("bst-search").onclick = async () => {
  const val = document.getElementById("bst-input").value;

  const res = await fetch("/bst/search", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ value: val })
  });

  const data = await res.json();
  document.getElementById("bst-info").innerText =
    data.found ? "‚úÖ Value Found" : "‚ùå Not Found";
};


document.getElementById("bst-max").onclick = async () => {
  const res = await fetch("/bst/max");
  const data = await res.json();
  document.getElementById("bst-info").innerText =
    "Max Value: " + data.max;
};


document.getElementById("bst-height").onclick = async () => {
  const res = await fetch("/bst/height");
  const data = await res.json();
  document.getElementById("bst-info").innerText =
    "Tree Height: " + data.height;
};

/* ---------------------------- */
/* GRAPH DEMO JS                */
/* ---------------------------- */
document.getElementById('graph-add-vertex').onclick = async () => {
  const label = document.getElementById('graph-vertex-label').value;
  const res = await fetch('/graph/add-vertex', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({label}) });
  const d = await res.json(); if (d.svg) insertSVG(document.getElementById('graph-display'), d.svg);
};

document.getElementById('graph-delete-vertex').onclick = async () => {
  const id = document.getElementById('graph-delete-vertex-id').value;
  const res = await fetch('/graph/delete-vertex', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({id}) });
  const d = await res.json(); if (d.svg) insertSVG(document.getElementById('graph-display'), d.svg);
};

document.getElementById('graph-add-edge').onclick = async () => {
  const u = document.getElementById('graph-edge-u').value;
  const v = document.getElementById('graph-edge-v').value;
  const directed = document.getElementById('graph-directed').checked;
  const res = await fetch('/graph/add-edge', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({u,v,directed}) });
  const d = await res.json(); if (d.svg) insertSVG(document.getElementById('graph-display'), d.svg);
};

document.getElementById('graph-set-weight').onclick = async () => {
  const u = document.getElementById('graph-edge-u').value;
  const v = document.getElementById('graph-edge-v').value;
  const weight = parseInt(document.getElementById('graph-weight').value || '1');
  const res = await fetch('/graph/set-weight', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({u,v,weight}) });
  const d = await res.json(); if (d.svg) insertSVG(document.getElementById('graph-display'), d.svg);
};

document.getElementById('graph-reset').onclick = async () => {
  const res = await fetch('/graph/reset', { method: 'POST' });
  const d = await res.json(); if (d.svg) insertSVG(document.getElementById('graph-display'), d.svg);
};

// load initial graph svg on page load
window.addEventListener('DOMContentLoaded', async () => {
  try { const res = await fetch('/graph/svg'); const d = await res.json(); if (d.svg) insertSVG(document.getElementById('graph-display'), d.svg); } catch(e){}
});

/* ----------------------------- */
/* Comments helpers             */
/* ----------------------------- */
async function submitComment(postId, parentId=null) {
  const ta = document.getElementById(`comment-input-${postId}`);
  if (!ta) return;
  const text = ta.value; // preserve whitespace
  if (!text) return;
  const res = await fetch('/comments/add', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ post_id: postId, comment: text, parent_id: parentId })
  });
  const data = await res.json();
  if (data.ok) {
    ta.value = '';
    // append latest comment snippet
    const list = document.getElementById(`comments-${postId}`);
    if (list) {
      const el = document.createElement('div');
      el.className = 'preserve';
      el.style.padding = '6px 0';
      el.innerText = data.comment.comment;
      list.prepend(el);
    }
  }
}

async function loadComments(postId) {
  const res = await fetch(`/posts/${postId}/comments`);
  const data = await res.json();
  const list = document.getElementById(`comments-${postId}`);
  if (!list) return;
  list.innerHTML = '';
  data.forEach(c => {
    const el = document.createElement('div');
    el.className = 'preserve';
    el.style.padding = '6px 0';
    el.innerText = c.comment;
    list.appendChild(el);
  });
}

// -----------------------------
// Delete + snackbar helpers
// -----------------------------
let pendingDeleteId = null;
let pendingDeleteTimeout = null;

async function deletePost(id) {
  // schedule server-side delete (5s) and show snackbar with cancel option
  pendingDeleteId = id;
  try {
    await fetch(`/delete/${id}`, { method: 'POST' });
  } catch (e) {
    // still show snackbar so user can retry
  }

  const snackbar = document.getElementById('snackbar');
  snackbar.style.display = 'flex';

  // clear any previous timeout
  if (pendingDeleteTimeout) clearTimeout(pendingDeleteTimeout);

  // After 5s hide snackbar and remove the post card from DOM (assume deletion occurred)
  pendingDeleteTimeout = setTimeout(() => {
    snackbar.style.display = 'none';
    const card = document.querySelector(`.post-card[data-id="${id}"]`);
    if (card) card.remove();
    pendingDeleteId = null;
    pendingDeleteTimeout = null;
  }, 5000);
}

// Vote handlers (delegated)
document.addEventListener('click', async (e) => {
  const up = e.target.closest('.vote-up');
  const down = e.target.closest('.vote-down');
  if (!up && !down) return;
  e.preventDefault();
  const btn = up || down;
  const id = btn.dataset.id;
  const way = up ? 'up' : 'down';
  try {
    const res = await fetch(`/vote/${id}/${way}`, { method: 'POST' });
    const data = await res.json();
    if (data.ok) {
      btn.querySelector('.count').innerText = way === 'up' ? data.up : data.down;
    }
  } catch (err) {
    console.error(err);
  }
});

function cancelDelete() {
  if (!pendingDeleteId) return;
  const id = pendingDeleteId;
  // cancel server-side scheduled delete
  fetch(`/delete/cancel/${id}`, { method: 'POST' }).then(() => {
    const snackbar = document.getElementById('snackbar');
    snackbar.style.display = 'none';
    if (pendingDeleteTimeout) { clearTimeout(pendingDeleteTimeout); pendingDeleteTimeout = null; }
    pendingDeleteId = null;
  }).catch(() => {
    // hide anyway
    const snackbar = document.getElementById('snackbar');
    snackbar.style.display = 'none';
    if (pendingDeleteTimeout) { clearTimeout(pendingDeleteTimeout); pendingDeleteTimeout = null; }
    pendingDeleteId = null;
  });
}

// GRID BACKGROUND EFFECT
document.addEventListener("DOMContentLoaded", () => {
  const grid = document.getElementById("bg-grid");
  const cellSize = 30;

  function createGrid() {
    grid.innerHTML = "";
    const cols = Math.ceil(window.innerWidth / cellSize) + 2;
    const rows = Math.ceil(window.innerHeight / cellSize) + 2;

    grid.style.gridTemplateColumns = `repeat(${cols}, ${cellSize}px)`;
    grid.style.width = `${cols * cellSize}px`;
    grid.style.height = `${rows * cellSize}px`;

    const total = cols * rows;
    for (let i = 0; i < total; i++) {
      const cell = document.createElement("div");
      cell.classList.add("grid-cell");
      grid.appendChild(cell);
    }

    return { cols, rows, cells: Array.from(grid.children) };
  }

  let { cols, rows, cells } = createGrid();

  function pulseCell(col, row) {
    if (col < 0 || row < 0 || col >= cols || row >= rows) return;
    const idx = row * cols + col;
    const cell = cells[idx];
    if (!cell) return;
    cell.classList.add("active", "pulse");
    setTimeout(() => cell.classList.remove("active"), 120);
    setTimeout(() => cell.classList.remove("pulse"), 400);
  }

  window.addEventListener("mousemove", e => {
    const rect = grid.getBoundingClientRect();
    const col = Math.floor((e.clientX - rect.left) / cellSize);
    const row = Math.floor((e.clientY - rect.top) / cellSize);

    for (let dx = -1; dx <= 1; dx++)
      for (let dy = -1; dy <= 1; dy++)
        pulseCell(col + dx, row + dy);
  });

  window.addEventListener("resize", () => {
    ({ cols, rows, cells } = createGrid());
  });
});

document.getElementById("bst-max").onclick = async () => {
  const res = await fetch("/bst/max");
  const data = await res.json();
  document.getElementById("bst-info").innerText =
    "Max Value: " + data.max;
};

document.getElementById("bst-height").onclick = async () => {
  const res = await fetch("/bst/height");
  const data = await res.json();
  document.getElementById("bst-info").innerText =
    "Tree Height: " + data.height;
};
</script>

{% endblock %}